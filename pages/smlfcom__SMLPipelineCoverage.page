<apex:page controller="smlfcom.SMLPipelineCovergeController" sidebar="false" showHeader="false" standardStylesheets="false" readOnly="true" applyBodyTag="false" applyHtmlTag="false" docType="html-5.0">
    <title>SML Pipeline Coverage</title>
    <style>
        .highcharts-credits .highcharts-button-box .highcharts-button-symbol {
            display: none;
        }

        #ui-datepicker-div {
            z-index: 6 !important;
        }
        #container,
        #container1 {
            min-width: 310px;
            max-width: 800px;
            height: 400px;
            margin: 0 auto
        }
        .font-blue{
            color: rgba(30, 149, 211, 0.75);
            font-weight: bold;
        }
    </style>
    <apex:composition template="smlfcom__SMLTemplateV2">
        <apex:define name="body">
            <apex:includeScript value="https://code.highcharts.com/highcharts.js" />
            <apex:includeScript value="https://code.highcharts.com/highcharts-more.js" />
            <apex:includeScript value="https://code.highcharts.com/modules/exporting.js" />
            <div class="page-header">
                <div class="container-bs">
                    <div class="title" data-step="1" data-intro="View how your pipeline has progressed over a period of time (demo data)">
                        <h1>Quota: </h1>
                        <h2>{!smlFilter.pageLabelNameMapping['SMLPipelineCoverage'].pageLabel}</h2>
                    </div>
                    <!-- /.title -->
                </div>
                <!-- /.container-bs -->
            </div>
            <!-- /.page-header -->

            <div class="container-bs">
                <div class="page-container">

                    <apex:form styleClass="sidebar" id="frm">
                        <div data-step="2" data-intro="Set Snapshot Duration to the length of time for which you want to see pipeline movements">
                            <div class="form-group">
                                <c:Change_owner_filter />
                                <apex:outputPanel layout="none" rendered="{!smlFilter.textFilterList != null && smlFilter.textFilterList.size > 0}">
                                    <apex:repeat value="{!smlFilter.textFilterList }" var="filterField">
                                        <div class="form-group">
                                            <label>{!filterField.fieldLabel}</label>
                                            <apex:selectList value="{!filterField.selectedmapValue[filterField.fieldAPIName]}" multiselect="false" size="1" styleClass="filterField form-control custom-select {!filterField.isFieldLinked} {!filterField.fieldAPIName}">
                                                <apex:selectOption itemLabel="All" itemValue="All"></apex:selectOption>
                                                <apex:selectOptions value="{!smlFilter.mapOfFieldAndValue[filterField.fieldAPIName]}"></apex:selectOptions>
                                            </apex:selectList>

                                        </div>
                                    </apex:repeat>
                                </apex:outputPanel>
                                <hr/>
                                <div class="form-group">
                                    <label>Close Date</label>
                                    <apex:selectList value="{!smlFilter.dateFilter }" multiselect="false" size="1" styleClass="filterField form-control custom-select">
                                        <apex:selectOptions value="{!smlFilter.listOfDateFilter }"></apex:selectOptions>
                                    </apex:selectList>
                                </div>
                                <hr/>
                                <div class="form-group">
                                    <label>Compare By</label>
                                    <apex:selectList value="{!selectedCompareBy}" multiselect="false" size="1" styleClass="filterField form-control custom-select">
                                        <apex:selectOptions value="{!compareByList}"></apex:selectOptions>
                                    </apex:selectList>

                                    <apex:inputText value="{!ownerStr}" styleClass="form-control hidden user-search-field-hidden" />
                                </div>
                                <div class="form-group">
                                    <label>Forecast List</label>
                                    <apex:selectList value="{!foreValue}" multiselect="false" size="1" styleClass="filterField form-control custom-select">
                                        <apex:selectOptions value="{!foreList}"></apex:selectOptions>
                                    </apex:selectList>

                                </div>
                            </div>
                            <div class="controls flex">
                                <div class="left">
                                    <a href="javascript:reset()" class="btn-bs btn-default btn-sm">Reset</a>
                                </div>
                                <div class="right">
                                    <a href="javascript:saveRules();javascript:refresh();" class="btn-bs btn-primary btn-sm">Refresh</a>
                                </div>
                            </div>
                            <!-- /.controls -->

                            <apex:actionFunction action="{!refreshData}" name="refresh" status="renderingStatus" />
                            <apex:actionFunction action="{!resetFilters}" name="reset" status="renderingStatus" />
                        </div>
                    </apex:form>
                    <!-- /.sidebar -->


                    <apex:outputPanel layout="block" id="contentDiv" styleClass="content">
                        <div class="card">
                            <div id="container"></div>
                        </div>
                        <br/>
                        <div class="card">
                            <center>
                                
                                <h3 id= "detailsMetric" >Metrics By {!selectedCompareByLabel}</h3>
                            </center>
                            <table id="comapareTable" class="table table-striped table-bordered" width="100%">
                                <thead>
                                    <tr class="text-center">
                                        <th>Compare</th>
                                        <th>Closed Won</th>
                                        <th>Plan</th>
                                        <th>Attainment</th>
                                        <th>Open Pipeline</th>
                                        <th>Pipeline Coverage</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <apex:repeat value="{!comparesList}" var="cl">
                                        <tr>
                                            <td>
                                                {!cl.groupName}
                                            </td>
                                            <td>
                                                $
                                                <apex:outputText value="{0, number, ###,###,##0.00}">
                                                    <apex:param value="{!cl.metric1}" /> </apex:outputText>
                                            </td>
                                            <td>
                                                $
                                                <apex:outputText value="{0, number, ###,###,##0.00}">
                                                    <apex:param value="{!cl.metric2}" /> </apex:outputText>
                                            </td>
                                            <td>
                                                {!cl.attainment}%
                                            </td>
                                            <td>
                                                $
                                                <apex:outputText value="{0, number, ###,###,##0.00}">
                                                    <apex:param value="{!cl.openPipe}" /> </apex:outputText>
                                            </td>
                                            <td>
                                                <apex:outputPanel layout="none" rendered="{!cl.pipeCoverage < 2}">
                                                    <div class="marker-box hover-item" data-toggle="tooltip" data-placement="right" data-html="true" data-trigger="hover" title="Low pipeline coverage may impact attainment">
                                                        <div class="content">
                                                            <span class="font-red">{!cl.pipeCoverage }x</span>
                                                        </div>
                                                    </div>
                                                </apex:outputPanel>
                                                <apex:outputPanel layout="none" rendered="{!cl.pipeCoverage >= 2}">
                                                    <span class="font-blue" >{!cl.pipeCoverage }x</span>
                                                </apex:outputPanel>
                                                
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                </tbody>
                            </table>

                        </div>
                        <br/>
                        <div class="card">
                            
                            <center>                                
                                <h3 id= "detailsMetric" >Current Opportunities</h3>
                            </center>
                            <table id="oppTable" class="table table-striped table-bordered" width="100%">
                                <thead>
                                    <tr class="text-center">
                                        <th>Opportunity</th>
                                        <th>Owner</th>
                                        <th>Amount</th>
                                        <th>Close Date</th>
                                        <th>Forecast</th>
                                        <th>Stage</th>
                                        <th>Win&nbsp;Likelihood</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <apex:repeat value="{!oppList}" var="cl">
                                        <tr>
                                            <td>
                                                <a href="/{!cl.opp.id}" target="_blank">{!cl.opp.Name}</a>
                                            </td>
                                            <td>
                                                <a href="/{!cl.opp.Owner.id}" target="_blank">{!cl.opp.Owner.Name}</a>
                                            </td>
                                            <td data-search="{!cl.opp.Amount}" data-sort="{!cl.opp.Amount}" class="align-right">
                                                    <apex:outputPanel layout="none" rendered="{!cl.oppChan.smlfcom__AmountChangePercent__c != null && ABS(cl.oppChan.smlfcom__AmountChangePercent__c) > averageAmountChangePercent}">
                                                        <div class="marker-box hover-item" data-toggle="tooltip" data-html="true" data-placement="right" data-trigger="hover" title="Actual amount change: {!cl.oppChan.AmountChangePercent__c}% {!IF(cl.oppChan.NumAmtIncreases__c != null && cl.oppChan.NumAmtIncreases__c >= 2,'<hr/>Number of times amount increased: ' + TEXT(cl.oppChan.NumAmtIncreases__c),'')} {!IF(cl.oppChan.NumAmtDecreases__c != null && cl.oppChan.NumAmtDecreases__c >= 2,'<hr/>Number of times amount decreased: '+ TEXT(cl.oppChan.NumAmtDecreases__c),'')}">
                                                            <div class="content">
                                                                $
                                                <apex:outputText value="{0, number, ###,###,##0}">
                                                    <apex:param value="{!cl.opp.Amount}" /> </apex:outputText>
                                                            </div>
                                                            <div class="marker">
                                                                <span class="{!IF(cl.oppChan.NumAmtIncreases__c != null && cl.oppChan.NumAmtIncreases__c > 0,'icon-arrow-up','icon-arrow-down')}"></span>
                                                            </div>
                                                        </div>
                                                    </apex:outputPanel>
                                                    <apex:outputPanel layout="none" rendered="{!cl.oppChan.smlfcom__AmountChangePercent__c == null || ABS(cl.oppchan.smlfcom__AmountChangePercent__c) <= averageAmountChangePercent}">
                                                        <div class="marker-box">
                                                            <div class="content">
                                                                $
                                                <apex:outputText value="{0, number, ###,###,##0}">
                                                    <apex:param value="{!cl.opp.Amount}" /> </apex:outputText>
                                                            </div>
                                                        </div>
                                                    </apex:outputPanel>
                                            </td>
                                            <td>
                                                    <apex:outputPanel layout="none" rendered="{!cl.oppChan.smlfcom__CloseDateQuarterChange__c == 'MoveIn'}">
                                                        <div class="marker-box date hover-item" data-toggle="tooltip" data-placement="right" data-html="true" data-trigger="hover" title="Close date change moved in by at least a quarter {!IF(cl.oppChan.CloseDateChange__c != null && cl.oppChan.CloseDateChange__c > 0,'<hr/>Close Date changed by days: '+TEXT(cl.oppChan.CloseDateChange__c),'')} {!IF(cl.oppChan.NumCloseDtIncreases__c!=null && cl.oppChan.NumCloseDtIncreases__c >= 2,'<hr/>Number of times close date moved in: '+TEXT(cl.oppChan.NumCloseDtIncreases__c),'')}">
                                                            <div class="content">
                                                               <apex:outputText value="{0,date,MM/dd/yy}">
                                                    <apex:param value="{!cl.opp.CloseDate}" /> </apex:outputText>
                                                            </div>
                                                            <div class="marker">
                                                                <span class="marker-green"></span>
                                                            </div>
                                                        </div>
                                                    </apex:outputPanel>

                                                    <apex:outputPanel layout="none" rendered="{!cl.oppChan.smlfcom__CloseDateQuarterChange__c == 'MoveOut'}">
                                                        <div class="marker-box hover-item" data-toggle="tooltip" data-placement="right" data-html="true" data-trigger="hover" title="Close date change moved out by at least a quarter {!IF(cl.oppChan.CloseDateChange__c != null && cl.oppChan.CloseDateChange__c > 0,'<hr/>Close Date changed by days: '+TEXT(cl.oppChan.CloseDateChange__c),'')} {!IF(cl.oppChan.NumCloseDtDecreases__c!=null && cl.oppChan.NumCloseDtDecreases__c >= 2,'<hr/>Number of times close date moved out: '+TEXT(cl.oppChan.NumCloseDtDecreases__c),'')}">
                                                            <div class="content">
                                                                <apex:outputText value="{0,date,MM/dd/yy}">
                                                    <apex:param value="{!cl.opp.CloseDate}" /> </apex:outputText>
                                                            </div>
                                                            <div class="marker">
                                                                <span class="marker-red"></span>
                                                            </div>
                                                        </div>
                                                    </apex:outputPanel>
                                                    
                                                    <apex:outputPanel layout="none" rendered="{!(cl.oppChan.smlfcom__CloseThisQuarterProbability__c != null && cl.oppChan.smlfcom__CloseThisQuarterProbability__c < 0.25) &&  (YEAR(cl.opp.CloseDate) == YEAR(Today()) && CEILING( MONTH(cl.opp.CloseDate) / 3 ) == CEILING( MONTH( Today() ) / 3 ) && (cl.oppChan.smlfcom__CloseDateQuarterChange__c != 'MoveIn' && cl.oppChan.smlfcom__CloseDateQuarterChange__c != 'MoveOut' && cl.oppChan.smlfcom__CloseDateQuarterChange__c != 'NoQrtrChange'))}">
                                                        <div class="marker-box hover-item" data-toggle="tooltip" data-placement="right" data-html="true" data-trigger="hover" title="Our model predicts that this opportunity is not likely to close this quarter">
                                                            <div class="content">
                                                                <apex:outputText value="{0,date,MM/dd/yy}">
                                                    <apex:param value="{!cl.opp.CloseDate}" /> </apex:outputText>
                                                            </div>
                                                            <div class="marker">
                                                                <span class="icon-exclamation red"></span>
                                                            </div>
                                                        </div>
                                                    </apex:outputPanel>
                                                    
                                                    <apex:outputPanel layout="none" rendered="{!cl.oppChan.smlfcom__CloseDateQuarterChange__c == null || cl.oppChan.smlfcom__CloseDateQuarterChange__c == 'NoQrtrChange'}">
                                                        <div class="marker-box">
                                                            <div class="content">
                                                                <apex:outputText value="{0,date,MM/dd/yy}">
                                                    <apex:param value="{!cl.opp.CloseDate}" /> </apex:outputText>
                                                            </div>
                                                        </div>
                                                    </apex:outputPanel>
                                                
                                            </td>
                                            <td>
                                                <apex:outputPanel layout="none" rendered="{!cl.oppChan.smlfcom__NumTimesFCRepeated__c != null && cl.oppChan.smlfcom__NumTimesFCRepeated__c > 1}">
                                                        <div class="marker-box hover-item" data-toggle="tooltip" data-placement="right" data-html="true" data-trigger="hover" title="{!cl.oppChan.RepeatedForecastCat__c} has repeated more than once">
                                                            <div class="content">
                                                                {!cl.opp.ForecastCategoryName}
                                                            </div>
                                                            <div class="marker">
                                                                <span class="icon-update red"></span>
                                                            </div>
                                                        </div>
                                                    </apex:outputPanel>
                                                    <apex:outputPanel layout="none" rendered="{!cl.oppChan.smlfcom__NumTimesFCRepeated__c == null || cl.oppChan.smlfcom__NumTimesFCRepeated__c <= 1}">
                                                        <div class="marker-box">
                                                            <div class="content">
                                                                {!cl.opp.ForecastCategoryName}
                                                            </div>
                                                        </div>
                                                    </apex:outputPanel>
                                            </td>
                                            <td>
                                                   
                                                    <apex:outputPanel layout="none" rendered="{!cl.oppChan.smlfcom__DaysInCurrentStage__c != null &&  cl.oppChan.smlfcom__DaysInCurrentStage__c >= averageDaysInCurrentStage}">
                                                        <div class="marker-box hover-item" data-toggle="tooltip" data-placement="right" data-html="true" data-trigger="hover" title="Days in current stage: {!cl.oppChan.DaysInCurrentStage__c}">
                                                            <div class="content">
                                                                {!cl.opp.StageName}
                                                            </div>
                                                            <div class="marker">
                                                                <span class="icon-exclamation red"></span>
                                                            </div>
                                                        </div>
                                                    </apex:outputPanel>
                                                    <apex:outputPanel layout="none" rendered="{! cl.oppChan.DaysInCurrentStage__c == null || cl.oppChan.DaysInCurrentStage__c < averageDaysInCurrentStage }">
                                                        <div class="marker-box">
                                                            <div class="content">
                                                                {!cl.opp.StageName}
                                                            </div>
                                                        </div>
                                                    </apex:outputPanel>
                                                </td>

                                                <td style= "display : table-cell" data-search="{!cl.oppChan.Win_Score__c}" data-sort="{!cl.oppChan.Win_Score__c}" class="likelihood">
                                                    <div class="hover-item" data-toggle="tooltip" data-html="true" data-placement="right" data-trigger="hover" title="{!IF(cl.oppChan.PositiveReason__c == '','',cl.oppChan.PositiveReason__c)} {!IF(cl.oppChan.NegativeReason__c == '','','<hr/>'+cl.oppChan.NegativeReason__c)}">
                                                        <apex:outputPanel layout="none" rendered="{!cl.oppChan.smlfcom__Win_Score__c != null && cl.oppChan.smlfcom__Win_Score__c >= 0.75}">
                                                            <span class="font-green">Most Likely</span>
                                                        </apex:outputPanel>
                                                        <apex:outputPanel layout="none" rendered="{!cl.oppChan.smlfcom__Win_Score__c == null || (cl.oppChan.smlfcom__Win_Score__c < 0.75 && cl.oppChan.smlfcom__Win_Score__c > 0.25)}">
                                                            <span class="font-yellow">Medium</span>
                                                        </apex:outputPanel>
                                                        <apex:outputPanel layout="none" rendered="{!cl.oppChan.smlfcom__Win_Score__c != null && cl.oppChan.smlfcom__Win_Score__c <= 0.25}">
                                                            <span class="font-red">Least Likely</span>
                                                        </apex:outputPanel>
                                                    </div>
                                                </td>
                                        </tr>
                                    </apex:repeat>
                                </tbody>
                            </table>
                        </div>
                        <br/>
                        
                        <div class="card">
                            <div id="container1"></div>
                        </div>
                    </apex:outputPanel>
                    <!-- /.content -->

                </div>
            </div>
            <!-- /.container-bs -->
        </apex:define>
    </apex:composition>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <apex:remoteObjects jsNamespace="remote_user">
        <apex:remoteObjectModel name="User" fields="Id,Name" />
    </apex:remoteObjects>
    <script>
        var $j = jQuery.noConflict();
        $(function() {
            createChart();
        });
         $("#oppTable").on( 'draw.dt', function () {
            $('.hover-item').tooltip({
                content: function () {
                    return $(this).prop('title');
                }
            });
        });

        $('.hover-item').tooltip({
            content: function () {
                return $(this).prop('title');
            }
        });
        function createChart() {
            var Stacked_Data = jQuery.parseJSON('{!JSENCODE(JSONString_stackedView)}');
            var Line_Data = jQuery.parseJSON('{!JSENCODE(lineViewJSON)}');

            var categoriesArray = [];
            $.each(Line_Data.listOfLineCategory, function(index, value) {
                var myDate = getDateOfWeek(value, 2017);
                categoriesArray.push(myDate);
            });
            console.log(Line_Data);

            Highcharts.chart('container', {

                title: {
                    text: '{!titleString }'
                },

                subtitle: {
                    text: ''
                },

                yAxis: {
                    title: {
                        text: 'Amount'
                    }
                },
                legend: {
                    layout: 'vertical',
                    align: 'right',
                    verticalAlign: 'middle'
                },
                xAxis: {
                    categories: categoriesArray,
                    title: {
                        text: 'Week Of (Mondays)'
                    }
                },
                credits: false,

                series: Line_Data.listOfMetric1SeriesData

            });
            categoriesArray = [];
            $.each(Stacked_Data.listOfBarCategory, function(index, value) {
                var myDate = getDateOfWeek(value, 2017);
                categoriesArray.push(myDate);
            });
            Highcharts.chart('container1', {
                chart: {
                    type: 'column'
                },
                credits: false,
                title: {
                    text: 'Open Pipeline'
                },
                xAxis: {
                    categories: categoriesArray,
                    title: {
                        text: 'Close Date By Week'
                    }
                },
                yAxis: {
                    min: 0,
                    title: {
                        text: 'Amount'
                    },
                    stackLabels: {
                        enabled: true,
                        style: {
                            fontWeight: 'bold',
                            color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
                        }
                    }
                },
                legend: {
                    align: 'right',
                    x: -30,
                    verticalAlign: 'top',
                    y: 25,
                    floating: true,
                    backgroundColor: (Highcharts.theme && Highcharts.theme.background2) || 'white',
                    borderColor: '#CCC',
                    borderWidth: 1,
                    shadow: false
                },
                tooltip: {
                    headerFormat: '<b>{point.x}</b><br/>',
                    pointFormat: '{series.name}: {point.y}<br/>Total: {point.stackTotal}'
                },
                plotOptions: {
                    column: {
                        stacking: 'normal'
                    }
                },
                series: Stacked_Data.listOfBarSeriesData
            });
            $("#comapareTable").DataTable();
            $("#oppTable").DataTable({
                "pageLength": 10,
                "order": [
                    [2, "desc"]
                ],
                "lengthMenu": [5, 10, 30]
            });
        }

        function getDateOfWeek(weekNumber, year) {
            var dt = new Date(year, 0, 2 + ((weekNumber - 1) * 7));

            var m_names = new Array("Jan", "Feb", "Mar",
                "Apr", "May", "Jun", "Jul", "Aug", "Sep",
                "Oct", "Nov", "Dec");
            var curr_date = dt.getDate();
            var curr_month = dt.getMonth();
            var curr_year = dt.getFullYear();
            return m_names[curr_month] + " " + curr_date +
                ", " + curr_year;
        }
    </script>

</apex:page>