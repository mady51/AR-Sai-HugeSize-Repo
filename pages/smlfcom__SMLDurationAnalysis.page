<apex:page controller="smlfcom.SMLDurationAnalysisController" sidebar="false" showHeader="false" standardStylesheets="false" readOnly="true" applyBodyTag="false" applyHtmlTag="false" docType="html-5.0">
    <title>SML Duration Analysis</title>
    <style>
        .highcharts-credits .highcharts-button-box .highcharts-button-symbol {
            display: none;
        }

        #ui-datepicker-div {
            z-index: 6 !important;
        }

        #result {
            text-align: right;
            color: gray;
            min-height: 2em;
        }

        #table-sparkline {
            margin: 0 auto;
            border-collapse: collapse;
        }

        th {
            font-weight: bold;
            text-align: left;
        }

        .cardGrid {
            margin-left: 10px;
        }

        td,
        th {
            padding: 5px;
            border-bottom: 1px solid silver;
            height: 20px;
        }

        thead th {
            border-top: 2px solid gray;
            border-bottom: 2px solid gray;
        }

        .highcharts-tooltip>span {
            background: white;
            border: 1px solid silver;
            border-radius: 3px;
            box-shadow: 1px 1px 2px #888;
            padding: 8px;
        }

        .swiper-container {
            width: 100%;
            height: 100%;
            margin-left: auto;
            margin-right: auto;
        }

        .swiper-slide {
            text-align: center;
            font-size: 18px;
            background: #fff;
            /* Center slide text vertically */
            display: -webkit-box;
            display: -ms-flexbox;
            display: -webkit-flex;
            display: flex;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-box-align: center;
            -ms-flex-align: center;
            -webkit-align-items: center;
            align-items: center;
            max-width: 100%;
            padding: 0px 50px;
        }

        .selectList {
            margin-left: -20px;
        }
        .font-blue{
            color: rgba(30, 149, 211, 0.75);
            font-weight: bold;
        }
    </style>
    <apex:composition template="smlfcom__SMLTemplateV2">
        <apex:define name="body">
            <apex:includeScript value="https://code.highcharts.com/highcharts.js" />
            <apex:includeScript value="https://code.highcharts.com/highcharts-more.js" />
            <apex:includeScript value="https://code.highcharts.com/modules/exporting.js" />
            <div class="page-header">
                <div class="container-bs">
                    <div class="title" data-step="1" data-intro="View how your pipeline has progressed over a period of time (demo data)">
                        <h1>Highlights: </h1>
                        <h2>{!smlFilter.pageLabelNameMapping['SMLDurationAnalysis'].pageLabel}</h2>
                    </div>
                    <!-- /.title -->
                </div>
                <!-- /.container-bs -->
            </div>
            <!-- /.page-header -->
            <apex:form id="frm">

                <div class="container-bs">
                    <div class="page-container">
                        <div class="sidebar">
                            <div data-step="2" data-intro="Set Snapshot Duration to the length of time for which you want to see pipeline movements">
                                <div class="form-group">
                                <c:Change_owner_filter />
                                    <apex:inputText value="{!ownerStr}" styleClass="form-control hidden user-search-field-hidden" />
                                    <apex:outputPanel layout="none" rendered="{!smlFilter.textFilterList != null && smlFilter.textFilterList.size > 0}">
                                        <apex:repeat value="{!smlFilter.textFilterList }" var="filterField">
                                            <div class="form-group">
                                                <label>{!filterField.fieldLabel}</label>
                                                <apex:selectList value="{!filterField.selectedmapValue[filterField.fieldAPIName]}" multiselect="false" size="1" styleClass="filterField form-control custom-select {!filterField.isFieldLinked} {!filterField.fieldAPIName}">
                                                    <apex:selectOption itemLabel="All" itemValue="All"></apex:selectOption>
                                                    <apex:selectOptions value="{!filterField.fieldValues}"></apex:selectOptions>
                                                </apex:selectList>

                                            </div>
                                        </apex:repeat>
                                    </apex:outputPanel>


                                </div>
                                <hr/>
                                <div class="form-group">
                                    <label>Compare By</label>
                                    <apex:selectList value="{!selectedCompareBy}" multiselect="false" size="1" styleClass="filterField form-control custom-select">
                                        <apex:selectOptions value="{!compareByList}"></apex:selectOptions>
                                    </apex:selectList>

                                </div>
                                <div class="controls flex">
                                    <div class="left">
                                        <a href="javascript:reset()" class="btn-bs btn-default btn-sm">Reset</a>
                                    </div>
                                    <div class="right">
                                        <a href="javascript:saveRules();javascript:refresh();" class="btn-bs btn-primary btn-sm">Refresh</a>
                                    </div>
                                </div>
                                <!-- /.controls -->

                                <apex:actionFunction action="{!refreshData}" name="refresh" status="renderingStatus" />
                                <apex:actionFunction action="{!resetFilters}" name="reset" status="renderingStatus" />
                                <apex:actionFunction name="showModal" rerender="modPanel" status="renderingStatus" />
                            </div>

                        </div>
                        <apex:outputPanel layout="block" id="contentDiv" styleClass="content">

                            <div class="flex-row two-col" style="margin-bottom:10px">
                                <div class="form-group"></div>
                                <div class="form-group">
                                    <a href="javascript:openSliderViewModal()" class="btn-blank" style="float: right;"><img src="{!URLFOR($Resource.SMLTemplateV2, 'img/icons/insights.svg')}" /></a>
                                </div>
                            </div>
                            <div class="row ">
                                <div class="col-sm-8 card cardGrid">
                                    <div id="duration_chart_container" />
                                </div>
                                <div class="col-sm-3  cardGrid">

                                    <div class="table-content hidden" id="durationTableContainer">
                                        <div class="content">
                                            <table id="durTable" class="table table-striped table-bordered" width="100%">
                                                <thead>
                                                    <tr>
                                                        <th>Opportunity</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <apex:outputPanel id="compPanel">
                                <br/><br/>
                                <center>
                                    <h2 id="details"> Metrics By {!selectedCompareData}</h2>
                                </center>
                                <div class="card">
                                    <table id="comapareTable" class="table table-striped table-bordered" width="100%">
                                        <thead>
                                            <tr class="text-center">
                                                <th>Group</th>
                                                <th>velocity</th>
                                                <th>Duration in days</th>
                                                <th>Days since last activity</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <apex:repeat value="{!comparesList}" var="cl">
                                                <tr>
                                                    <td>
                                                        {!cl.groupName}
                                                    </td>
                                                    <td id="Bucket">
                                                        {!cl.Bucket}
                                                    </td><!--{!(cl.Amount > avgMetric1[cl.groupName])}{!(cl.Count<= avgMetric2[cl.groupName])} --> 
                                                    <apex:outputPanel rendered="{!(cl.Amount > 30)}">
                                                        <td class="font-red">
                                                            {!cl.Amount}
                                                        </td>
                                                    </apex:outputPanel>
                                                    <apex:outputPanel rendered="{!(cl.Amount <= 30)}">
                                                        <td class="font-blue">
                                                            {!cl.Amount}
                                                        </td>
                                                    </apex:outputPanel>
                                                    <apex:outputPanel rendered="{!(cl.Count> 20)}">
                                                        <td class="font-red">
                                                            {!cl.Count}
                                                        </td>
                                                    </apex:outputPanel>
                                                    <apex:outputPanel rendered="{!(cl.Count<= 20)}">
                                                        <td class="font-blue">
                                                            {!cl.Count}
                                                        </td>
                                                    </apex:outputPanel>
                                                </tr>
                                            </apex:repeat>
                                        </tbody>
                                    </table>
                                </div>
                            </apex:outputPanel>
                        </apex:outputPanel>
                        <!-- /.content -->
                    </div>
                </div>
                <!-- /.container-bs -->

                <apex:outputPanel id="modalPanel">
                    <div class="modal fade" id="sliderModal" tabindex="-1" role="dialog" aria-labelledby="sliderModalLabel">
                        <apex:outputPanel id="modPanel">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                        <center>
                                            <h3>Highlights</h3>
                                        </center>
                                    </div>
                                    <div class="modal-body" style="height: 300px">
                                        <div class="swiper-container">
                                            <div class="swiper-wrapper" id="swiperbody">
                                                <apex:repeat value="{!sliderTexts}" var="data">
                                                    <div class="swiper-slide">
                                                        <apex:outputText value="{!data}" escape="false" />
                                                    </div>
                                                </apex:repeat>
                                            </div>
                                            <div class="swiper-pagination"></div>

                                            <div class="swiper-button-next"></div>
                                            <div class="swiper-button-prev"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <script type="text/javascript">
                                var swiper = new Swiper('.swiper-container', {
                                    pagination: '.swiper-pagination',
                                    nextButton: '.swiper-button-next',
                                    prevButton: '.swiper-button-prev',
                                    slidesPerView: 1,
                                    paginationClickable: true,
                                    spaceBetween: 30,
                                    loop: true
                                });
                            </script>
                        </apex:outputPanel>
                    </div>
                </apex:outputPanel>
            </apex:form>
        </apex:define>
    </apex:composition>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <apex:remoteObjects jsNamespace="remote_user">
        <apex:remoteObjectModel name="User" fields="Id,Name" />
    </apex:remoteObjects>
    <script>
        var $j = jQuery.noConflict();
        $(function() {
            createChart();
            $('#comapareTable').DataTable();
        });

        function openSliderViewModal() {
            $("#sliderModal").modal('show');
            showModal();
        }

        function createChart() {
            var _svData = {!JSONString_Duration
            };
            var _oppTable = null;
            console.log(_svData);
            $('#duration_chart_container').highcharts({
                chart: {
                    type: 'bar'
                },
                title: {
                    text: null
                },
                xAxis: {
                    categories: _svData.listOfBarCategory,
                    title: {
                        text: 'Owner Name'
                    }
                },
                yAxis: {
                    min: 0,
                    title: {
                        text: 'Duration in Days'
                    },
                    labels: {
                        overflow: 'justify'
                    }
                },
                tooltip: {
                    valueSuffix: ''
                },
                plotOptions: {
                    series: {
                        stacking: 'normal',
                        cursor: 'pointer',
                        point: {
                            events: {
                                click: function() {
                                    Visualforce.remoting.Manager.invokeAction(
                                        '{!$RemoteAction.SMLDurationAnalysisController.getOppTable }',
                                        this.category, this.series.name, '{!selectedCompareBy}',
                                        function(result, event) {
                                            var table = $('#durTable').DataTable();
                                            table.destroy();
                                            var opp_table = $("#durationTableContainer tbody");
                                            opp_table.empty();

                                            opp_table.append(result);
                                            _oppTable = $("#durTable").DataTable({
                                                "pageLength": 4,
                                                "bFilter": false,
                                                "bLengthChange": false,
                                                "bInfo": false
                                            });
                                            $('#durTable_paginate').parent().removeClass('col-sm-7').addClass('col-sm-12');
                                            $(".table-content").removeClass('hidden');
                                        }, {
                                            escape: false
                                        });
                                }
                            }
                        }
                    }
                },
                credits: {
                    enabled: false
                },
                series: _svData.listOfBarSeriesData
            });
        }
    </script>

</apex:page>